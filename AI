import streamlit as st
from PIL import Image
import numpy as np

st.set_page_config(page_title="AI Embroidery Preview", layout="centered")
st.title("ğŸ§µ ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±ØªÙƒ Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² Ø¨Ø§Ù„Ø®ÙŠÙˆØ·")

st.markdown("""
Ø§Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ Ø¨ØµÙŠØºØ© PNG Ø´ÙØ§ÙØ©ØŒ ÙˆÙ‡Ù†Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ·Ø±ÙŠØ² ÙÙˆØ±ÙŠØ©.
Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø¬Ù… Ø£Ùˆ Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ ÙƒÙ„Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ø§Ù„Ù„ÙŠ ØªØ­Øª.
""")

uploaded_file = st.file_uploader("ğŸ“¤ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§", type=["png"])

num_colors = st.slider("ğŸ¨ Ø§Ø®ØªØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„ØªØ·Ø±ÙŠØ²:", min_value=5, max_value=16, value=8)

image = None
new_image = None
if uploaded_file:
    image = Image.open(uploaded_file).convert("RGBA")
    st.image(image, caption="ğŸ“Œ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©", use_column_width=True)

    # ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    img_np = np.array(image)
    img_flat = img_np.reshape((-1, 4))
    unique_colors = np.unique(img_flat, axis=0)
    st.markdown(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ©: {len(unique_colors)}")

    if len(unique_colors) > num_colors:
        st.warning(f"ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ¨Ø³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ {num_colors} Ø£Ù„ÙˆØ§Ù†...")
        from sklearn.cluster import KMeans
        flat_rgb = img_flat[:, :3]
        kmeans = KMeans(n_clusters=num_colors, random_state=0).fit(flat_rgb)
        clustered = kmeans.cluster_centers_.astype(np.uint8)
        labels = kmeans.labels_
        recolored = clustered[labels].reshape(img_np.shape[:2] + (3,))
        new_image = Image.fromarray(recolored.astype(np.uint8))
        st.image(new_image, caption=f"ğŸ§¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø© ({num_colors} Ø£Ù„ÙˆØ§Ù†)", use_column_width=True)
    else:
        st.image(image, caption="ğŸ§¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø© (Ø£Ù„ÙˆØ§Ù† Ø£ØµÙ„ÙŠØ©)", use_column_width=True)

    st.success("âœ”ï¸ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù‡Ù†ÙØ¹Ù„ Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„ØªØµØ¯ÙŠØ± Ù„Ù…Ù„Ù DST")
else:
    st.info("ğŸ“ Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© PNG Ø´ÙØ§ÙØ© Ù„Ù„Ø¨Ø¯Ø¡.")

# âœ… ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ© (Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙŠ)
st.markdown("---")
st.subheader("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ - Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ØªØ­Ø¨Ù‡")

if "messages" not in st.session_state:
    st.session_state.messages = []

for msg in st.session_state.messages:
    role = "ğŸ‘¤ Ø£Ù†Øª" if msg["role"] == "user" else "ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯"
    with st.chat_message(msg["role"]):
        st.markdown(f"**{role}:** {msg['content']}")

prompt = st.chat_input("âœï¸ Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨Ù‡...")
if prompt:
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(f"**ğŸ‘¤ Ø£Ù†Øª:** {prompt}")

    # Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¤Ù‚Øª (Ù‡Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø¹Ø¯ÙŠÙ†)
    reply = "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ: Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªØ¬Ø±ÙŠØ¨ÙŠ)"
    st.session_state.messages.append({"role": "assistant", "content": reply})
    with st.chat_message("assistant"):
        st.markdown(f"**ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯:** {reply}")
